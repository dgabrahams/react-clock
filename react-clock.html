<!DOCTYPE html>
<html>
  <head id="documentHead">
    <meta charset="UTF-8" />
    <title>Live Import Test</title>
    <script src="js/react.min.js"></script>
    <script src="js/react-dom.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/moment-timezone.min.js"></script>
    <script src="js/moment-timezone-with-data.js"></script>
    <script src="js/babel.min.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/default.css" />

  </head>
  <body id="body-main">
    <div id="react-main"></div>
    <script type="text/babel">

//https://stackoverflow.com/questions/7389328/detect-if-browser-tab-has-focus
//window.onfocus and window.onblur - allows detection if the current tab is selected.

//https://stackoverflow.com/questions/1060008/is-there-a-way-to-detect-if-a-browser-window-is-not-currently-active


      var hasFocus=false;
      var loaded = false;

      // window.onload = function() {
      //     if (hasFocus) alert('example');
      //     loaded = true;
      // };
      // window.onfocus = function() { 
      //     if (loaded) alert('example');
      //     hasFocus = true;
      // };
      // window.onblur = function() { hasFocus = false; };



      var NTPtime = 0;//global variable to pass NTP time between components.//not needed

      var AddJS = React.createClass({
        getInitialState: function() {
          return {
            src: 'thing'
          };
        },
        componentDidMount: function() {
            console.log('addJS: componentDidMount');
            this.setState({src: this.props.src}, () => {
                console.log(this.state.src);
                let s = document.createElement('script');
                s.type = 'text/javascript';
                s.src = this.state.src;
                this.instance.appendChild(s);
            });
        },
        render: function() {
          return (
            <div ref={(el) => (this.instance = el)} />
          )
        }
      });

      var OutputList = React.createClass({
        render: function() {
          return (
            <ul>
              {this.props.list.map(function(listValue){
                return <li>{listValue.name}</li>;
              })}
            </ul>
          )
        }
      });

// [{ name: "Analogue Clock", fileName: "analogue-clock.js", cssFile: "analogue-clock.css" },{ name: "Flip Clock", fileName: "flip-clock.js", cssFile: "flip-clock.css" }]
      var ThemeListOutput = React.createClass({
        getInitialState: function() {
          return {
            themes: [{}],
            selectValue:'AnalogueClock'
          };
        },
        componentWillMount: function() {
            var self = this;

            var key = event.target.id;
            var val = event.target.value;
            var obj  = {};

            this.props.list.map(function(listValue) {
              obj = self.state;
              obj[listValue.name.replace(" ", "")] = listValue;
              self.setState(obj);//had to completely override, for some reason only the last added object in 'themes' key was being kept
            });
            console.log(this.state);
        },
        formAction: function() {

            console.log('***form action***');
            timerMain.removeTheme();
            timerMain.hideThemeSelector();
            console.log(this.state[this.state.selectValue].fileName);//works!
            var scriptSrc = '/js/'+this.state[this.state.selectValue].fileName;

            ReactDOM.render(
              <AddJS src={scriptSrc} />,
              document.getElementById('js-import')
            );
        },
        handleChange: function(e) {
            console.log(this.state);
            this.setState({selectValue: e.target.value}, () => {
                console.log('from change handle: '+this.state.selectValue);
            });
            console.log(this.state);
        },
        render: function() {
          return (
            <form action="javascript:void(0);">
              <select name="themeOptions" onChange={this.handleChange} >
                {this.props.list.map(function(listValue){
                  return <option value={listValue.name.replace(" ", "")}>{listValue.name}</option>;
                })}
              </select>
              <input type="button" value="Submit" onClick={this.formAction.bind(this)} />
            </form>
          )
        }
      });
//javascript:void(0);









//MAKE IT SO THAT USES CAN CHNE THE TIME ZONE OF THE CLOCK
//Dispaly the timezone they have selected under the clock
//allow multiple clocks displaying multiple timezones?







      var Timer3 = React.createClass({

          getInitialState: function() {
            return {};
          },
          componentWillMount: function () {
          },
          componentDidMount: function() {
              ReactDOM.render(
                <AddJS src='/js/digital-clock.js' />,
                document.getElementById('js-import')
              );
          },
          displayTime: function(xhttp,self,recieveTime,sentTime) {
            //https://github.com/hueniverse/sntp/blob/master/lib/index.js
            // Timestamp Name          ID   When Generated
            // ------------------------------------------------------------
            // Originate Timestamp     T1   time request sent by client
            // Receive Timestamp       T2   time request received by server
            // Transmit Timestamp      T3   time reply sent by server
            // Destination Timestamp   T4   time reply received by client
            
            // The roundtrip delay d and system clock offset t are defined as:
            
            // d = (T4 - T1) - (T3 - T2)     t = ((T2 - T1) + (T3 - T4)) / 2

            //var unix = Math.round(+new Date()/1000);//unix time stamp
            var T1 = Math.round(sentTime/1000);//taken from local time
            // console.log('T1: '+T1);

            var T4 = Math.round(recieveTime/1000);//taken from local time
            // console.log('T4: '+T4);

            var totalTrip = Math.round(T4 - T1);//round trip total in seconds, both taken from current local time
            console.log('totalTrip: '+totalTrip);

            // var response = '';
            // var T2, T3, output, outputString;
            var response, outputString;

            //if it doesn't take longer than 15 seconds
            if (totalTrip <= 10) {
                // console.log('totalTrip was <= 15');
                //this means that the total trip was less than 15 seconds. 
                //the request needs to be made at around 15-20 seconds past the current minute, this allows a safe passage of time.
                //then, when it gets recived, within ths function the current time local time can be checked and the current minute and hour compared.
                //the whole date can also be compared, and of course of local time zones need to be taken into consideration.
                //BUT - HERE THE WHOLE DATE IS COMPARED ALREADY

                //

                //response = xhttp.responseText;
                response = JSON.parse(xhttp.responseText);
                // T2 = parseInt(response['T2'], 10);
                // // console.log('T2: '+T2);

                // T3 = parseInt(response['T3'], 10);
                // // console.log('T3: '+T3);

                // // console.log('T1: '+typeof T1);
                // // console.log('T2: '+typeof T2);
                // // console.log('T3: '+typeof T3);
                // // console.log('T4: '+typeof T4);

                // var d = (T4 - T1) - (T3 - T2);
                // console.log('d: '+ d);

                // var t = ((T2 - T1) + (T3 - T4)) / 2;
                // console.log('t: '+ t);






                console.log( JSON.parse(xhttp.responseText) );

                //docs on date formats:
                //http://momentjs.com/docs/#/parsing/

                var ntpTime = response.ntp.match(/\d\d:\d\d:\d\d/g);
                console.log( 'ntpTime: '+ ntpTime );

                //https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
                //https://www.iana.org/time-zones

                var timeZone = JSON.parse(response.timeZone);
                // console.log('timezone: '+timeZone.time_zone);
                
                //gets the correct time according to the timezone got from the ip address server side
                // console.log('*** NTP Conversion using timezone of IP ***');
                var dateString = String(response.date)+' '+String(ntpTime);//NTP time WITHOUT statement of time zone
                //console.log('dateString: '+dateString);
                var momentNTPtime = moment( new Date( String(dateString) ).toString() );
                console.log( momentNTPtime.tz(timeZone.time_zone).format('YYYY-MM-DD HH:mm:ss') );
                console.log('*******');

                var currentLocalTime = new Date();

                console.log('Your time zone is: ' + timeZone.time_zone);
                console.log('NTP time is:                       ' + String(ntpTime) );
                // console.log('NTP time converted using timezone: ' + momentNTPtime.tz(timeZone.time_zone).format('YYYY-MM-DD HH:mm:ss') );
                //utc does not work in british summer time.
                //console.log('Local time on computer is:         ' + currentLocalTime.getUTCHours()+':'+currentLocalTime.getUTCMinutes()+':'+currentLocalTime.getUTCSeconds() );
                console.log('Local time on computer is:         ' + currentLocalTime );
                //remember unix time is universal throught the world. the same second ticks on every pc.
                var convertedLocalTime = Math.round(currentLocalTime/1000);
                // console.log('convertedLocalTime: '+convertedLocalTime);
                var convertedNTPTime = momentNTPtime.tz(timeZone.time_zone).unix();
                // console.log('convertedNTPTime: '+convertedNTPTime);
                
                console.log('--- *** ---');
                var timeoutputTest = momentNTPtime.tz(timeZone.time_zone).format('YYYY-MM-DD HH:mm:ss');
                console.log('timeoutputTest: '+timeoutputTest);
                timeoutputTest = new Date(timeoutputTest);
                console.log('timeoutputTest: '+timeoutputTest);
                timeoutputTest = Math.round(timeoutputTest/1000);
                console.log('timeoutputTest: '+timeoutputTest);
                console.log('--- *** ---');

                // var localDifference = timeoutputTest - convertedNTPTime;//local time will always be later than the NTP time recieved.
                var localDifference = convertedNTPTime - timeoutputTest;//local time will always be later than the NTP time recieved.
                console.log('Difference in seconds NTP to local machine: '+localDifference);

                var differenceHours = localDifference/3600;

                if ( String(localDifference).match(/-/g) === null ) {
                    console.log('this is not a negative number');
                    localDifference = '+' + String(localDifference);
                    differenceHours = '+' + String(differenceHours);
                }

                outputString = 'Time difference in seconds between NTP time gathered from the server and current local time is: ' + localDifference + ' or '+ differenceHours +' hours.';//60*60 = 3600 ... then divide new time by this to get hours
                outputString += 'This was gathered by comparing the IP address of the country your computer was located against the time currently set on your machine. You might need to adjust your time zone settings or the time your machine is set to.';

            } else {
              //this means any part of the date could be wrong as the seconds since 1st Jan 1970 were measured. - it doesn't as the two measurements were taken from the local time
              //but - could the timezone do this?
              outputString = 'There was greater than 10 seconds between the transmission and the receipt of data from the server.';
            }

            ReactDOM.render(
              React.createElement('div', {id : 'time-report-content'}, outputString),
              document.getElementById('time-report')
            );
            // return outputString;

          },
          handleTheme: function(xhttp,self) {

              var obj = JSON.parse(xhttp.responseText);
              console.log(obj);
              //obj = [obj];
              var newArray = [];

              for (var prop in obj) {
                  //console.log(`obj.${prop} = ${obj[prop]}`);
                  // console.log(this.state.obj);
                  newArray.push(obj[prop]);
              }

              ReactDOM.render(
                <ThemeListOutput list={newArray} />,
                document.getElementById('theme-list')
              );
          },
          getJSON: function(url,cFunction) {
        // only get needs to be implemented and tested.
              var self = this;
              var xhttp, sentTime;
              xhttp=new XMLHttpRequest();
              xhttp.onreadystatechange = function() {
                  if (this.readyState === 4 && this.status === 200) {
                    var recievedTime = new Date();
                    cFunction(this,self,recievedTime, sentTime);
                    // console.log(this.responseText);
                  } else if(this.readyState === 4 && this.status === 500) {
                    console.log('500 error...');
                    console.log(this.readyState);
                    console.log(this.responseText);
                    console.log('*********');
                  }//end else if
              };
              xhttp.open("GET", url, true);
              xhttp.send();
              sentTime = new Date();
          },
          xhttpGetTime: function(state) {
              //check current seconds till the next minute.
              //run below in a time out 5 seconds after the next minute.
              var setRunTime = new Date().getUTCSeconds();
              console.log('setRunTime: '+setRunTime);
              setRunTime = (65-parseInt(setRunTime,10))*1000;
              console.log('Program will run in: '+setRunTime);
              var self = this;
              // setTimeout(function(){ 
              //   console.log('current second: '+ new Date().getUTCSeconds() );
              //   // self.getJSON('http://localhost:3001/time', this.displayTime);
              // }.bind(this), setRunTime);//result should run 5 seconds into the next minute.
              // this.getJSON('http://localhost:3001/time', this.displayTime);
              this.getJSON('https://aqueous-meadow-38089.herokuapp.com/time', this.displayTime);
          },
          xhttpGetThemes: function(state) {
              // this.getJSON('http://localhost:3001/themes', this.handleTheme);
              this.getJSON('https://aqueous-meadow-38089.herokuapp.com/themes', this.handleTheme);
          },
          addThemeCSS: function (fileHref) {
              var node = document.createElement("link");
              node.setAttribute("id", "themeCSS");
              node.setAttribute("rel", "stylesheet");
              node.setAttribute("type", "text/css");
              node.setAttribute("href", String(fileHref));
              document.getElementById("documentHead").appendChild(node);
          },
          removeTheme: function() {
              ReactDOM.unmountComponentAtNode(document.getElementById('js-import'));
              ReactDOM.unmountComponentAtNode(document.getElementById('clock-display'));
              myRegistrationModal = '';
              document.getElementById('documentHead').removeChild(document.getElementById('themeCSS'));
          },
          hideThemeSelector: function() {
              ReactDOM.unmountComponentAtNode(document.getElementById('theme-list'));
          },
          render: function() {
            return (
              <div className="App">
                <div className="thing"><br />Do not send requests 15 seconds either side of a minute (15 seconds past to 45 seconds past)<br />Wait a minumum of 4 seconds between requests or you will get blocked!</div>
                <button type="button" onClick={this.xhttpGetTime.bind(this)}>get time</button>
                <button type="button" onClick={this.xhttpGetThemes.bind(this)}>Change Theme</button>
                <div>&nbsp;</div>
                <div id="time-report"></div>
                <div>&nbsp;</div>
                <div id="time-display"></div>
                <div>&nbsp;</div>
                <div id="theme-list"></div>
                <div>&nbsp;</div>
                <div id="clock-display"></div>
                <div>&nbsp;</div>
                <div id="js-import"></div>
              </div>
            );
          }

      });

      let timerMain = ReactDOM.render(React.createElement(Timer3, null), document.getElementById('react-main'));
      //timerMain.xhttpGetTime()
      //timerMain.removeTheme()



    </script>

  </body>
</html>